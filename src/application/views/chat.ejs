<%- include('partials/header') %>

<div class="container mt-5">
    <h1>Chat con l'Assistente</h1>

    <div class="card shadow chat-container d-flex flex-column mt-2 mb-5" style="max-height:25rem;" id="chatContainer">
        <div class="message bot-message">
            Ciao! Come posso aiutarti oggi riguardo l'UnivPM?
        </div>
    </div>

    <div class="input-group mt-4 mb-2 shadow">
        <input type="text" id="userInput" class="form-control" placeholder="Scrivi la tua domanda..." aria-label="Domanda">
        <button class="btn btn-outline-primary" type="button" id="sendBtn">Invia</button>
    </div>
</div>

<script>
    const chatContainer = document.getElementById('chatContainer');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');

    function appendMessage(text, isUser) {
        const div = document.createElement('div');
        div.classList.add('message');
        div.classList.add(isUser ? 'user-message' : 'bot-message');
        div.textContent = text;
        chatContainer.appendChild(div);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    async function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;

        appendMessage(text, true);
        userInput.value = '';
        userInput.disabled = true;
        sendBtn.disabled = true;
        sendBtn.textContent = 'Elaborazione...';

        try {
            const response = await fetch('/api/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question: text })
            });

            const data = await response.json();

            if (response.ok) {
                appendMessage(data.answer, false);
            } else {
                appendMessage("Errore: " + (data.error || "Impossibile contattare il server."), false);
            }
        } catch (error) {
            appendMessage("Errore di connessione.", false);
        } finally {
            userInput.disabled = false;
            sendBtn.disabled = false;
            sendBtn.textContent = 'Invia';
            userInput.focus();
        }
    }

    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });
</script>

<%- include('partials/footer') %>
